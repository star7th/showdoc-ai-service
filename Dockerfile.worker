# ============================================
# Worker 专用 Dockerfile（精简版）
# 移除了不必要的 Web 框架和 LLM SDK，节省 40-60MB
# ============================================
FROM python:3.12-slim AS base

WORKDIR /app

# 设置环境变量
ENV PYTHONUNBUFFERED=1
ENV PIP_PROGRESS_BAR=off
# 禁用所有 BLAS/数学库的多线程，避免 pthread 问题
ENV OPENBLAS_NUM_THREADS=1
ENV OMP_NUM_THREADS=1
ENV MKL_NUM_THREADS=1
ENV NUMEXPR_NUM_THREADS=1
ENV VECLIB_MAXIMUM_THREADS=1
# 禁用 transformers 和 tokenizers 的多线程操作
ENV TOKENIZERS_PARALLELISM=false
ENV HF_HUB_DISABLE_PROGRESS_BARS=1
ENV TRANSFORMERS_NO_ADVISORY_WARNINGS=1
ENV HF_HUB_DOWNLOAD_TIMEOUT=300
# Python 优化：不生成 .pyc 文件（运行时不需要）
ENV PYTHONDONTWRITEBYTECODE=1
# Python 内存优化
ENV PYTHONOPTIMIZE=2
ENV PYTHONHASHSEED=0
ENV MALLOC_ARENA_MAX=2

# 配置 pip 使用清华大学镜像源并更新 pip
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn && \
    pip install --no-cache-dir --upgrade pip

# 复制 Worker 专用依赖文件
COPY requirements-worker.txt .

# 安装 Python 依赖（合并命令以减少层数）
RUN pip install --no-cache-dir -r requirements-worker.txt && \
    # 清理 pip 缓存和临时文件
    pip cache purge && \
    # 清理 Python 缓存文件（如果存在）
    find /usr/local/lib/python3.12 -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true && \
    find /usr/local/lib/python3.12 -type f -name "*.pyc" -delete 2>/dev/null || true && \
    find /usr/local/lib/python3.12 -type f -name "*.pyo" -delete 2>/dev/null || true && \
    # 清理不必要的测试和示例文件
    find /usr/local/lib/python3.12/site-packages -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find /usr/local/lib/python3.12/site-packages -type d -name "test" -exec rm -rf {} + 2>/dev/null || true && \
    find /usr/local/lib/python3.12/site-packages -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true && \
    find /usr/local/lib/python3.12/site-packages -type d -name "example" -exec rm -rf {} + 2>/dev/null || true && \
    # 清理文档文件
    find /usr/local/lib/python3.12/site-packages -type f -name "*.md" -delete 2>/dev/null || true && \
    find /usr/local/lib/python3.12/site-packages -type f -name "*.rst" -delete 2>/dev/null || true && \
    find /usr/local/lib/python3.12/site-packages -type f -name "LICENSE*" -delete 2>/dev/null || true && \
    find /usr/local/lib/python3.12/site-packages -type f -name "CHANGELOG*" -delete 2>/dev/null || true && \
    find /usr/local/lib/python3.12/site-packages -type f -name "AUTHORS*" -delete 2>/dev/null || true && \
    find /usr/local/lib/python3.12/site-packages -type f -name "CONTRIBUTING*" -delete 2>/dev/null || true && \
    # 清理空目录
    find /usr/local/lib/python3.12 -type d -empty -delete 2>/dev/null || true && \
    echo "✅ Worker 依赖安装和清理完成"

# ============================================
# 第二阶段：最终镜像（基于基础镜像，只添加代码）
# ============================================
FROM base AS final

# 复制应用代码（只复制 Worker 需要的部分）
COPY app/config.py app/config.py
COPY app/__init__.py app/__init__.py
COPY app/models/ app/models/
COPY app/services/ app/services/
COPY app/utils/ app/utils/
COPY worker/ worker/

# 清理应用代码的缓存文件（如果存在）
RUN find /app -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true && \
    find /app -type f -name "*.pyc" -delete 2>/dev/null || true && \
    find /app -type f -name "*.pyo" -delete 2>/dev/null || true && \
    echo "✅ Worker 应用代码清理完成"

# Worker 不需要暴露端口（不提供 HTTP 服务）

# 启动命令（会被 docker-compose 覆盖）
# 使用 gevent pool 支持并发，concurrency 可在 docker-compose 中调整
CMD ["celery", "-A", "worker.celery_app", "worker", "--loglevel=warning", "--pool=gevent", "--concurrency=3"]

